<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Location & Time Check</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .card { max-width: 760px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 12px; }
    h2 { margin-top: 0; }
    label { display:block; margin: 12px 0 6px; font-weight: 600; }
    input, select, button { padding: 10px; width: 100%; box-sizing: border-box; }
    input[disabled] { background: rgba(127,127,127,.08); }
    button { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .ok { color: #0a7b22; font-weight: 700; }
    .warn { color: #b45309; font-weight: 700; }
    .err { color: #b91c1c; font-weight: 700; }
    .muted { color: #666; font-size: 0.92rem; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; margin-left:8px; font-size: 0.85rem; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; margin:6px 6px 0 0; cursor:pointer; user-select:none; }
    .hidden { display:none; }
    .hint { font-size: .85rem; color: #555; margin-top: 4px; }
    .spinner { display:inline-block; width: 14px; height: 14px; border:2px solid #bbb; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: -2px; margin-right:6px;}
    @keyframes spin { to { transform: rotate(360deg); } }
    .sugg-box { margin-top: 6px; }
    .sugg-title { font-size:.85rem; color:#555; margin: 4px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Sales Location & Time Check</h2>
    <p class="muted">Input your name and select dealer to check your location and time spent at the dealer.</p>

    <!-- Sales Name -->
    <label for="salesNameInput">Sales Name</label>
    <input id="salesNameInput" type="text" placeholder="Type sales name..." list="salesNameList" autocomplete="off" />
    <datalist id="salesNameList"></datalist>
    <div class="sugg-box">
      <div class="sugg-title">Suggestions</div>
      <div id="salesNameSuggestions"></div>
    </div>

    <!-- Dealer Name -->
    <label for="dealerInput">Search dealer by name</label>
    <input id="dealerInput" type="text" placeholder="Type dealer name…" autocomplete="off" />
    <div class="sugg-box">
      <div class="sugg-title">Matched Dealers</div>
      <div id="dealerSuggestions"></div>
    </div>
    <div class="hint" id="dealerHint" aria-live="polite"></div>

    <!-- Coordinates -->
    <div class="row" style="margin-top:8px;">
      <div>
        <label>Dealer Coordinates</label>
        <input id="dealerCoords" type="text" disabled placeholder="—" />
      </div>
      <div>
        <label>Your Live GPS</label>
        <input id="myCoords" type="text" disabled placeholder="—" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Distance to Dealer (meters)</label>
        <input id="distance" type="text" disabled placeholder="—" />
      </div>
      <div>
        <label>Status</label>
        <input id="status" type="text" disabled placeholder="—" aria-live="polite" />
      </div>
    </div>

    <!-- Jam Login + Time Since Login -->
    <div class="row">
      <div>
        <label>Jam Login (HH:MM)</label>
        <input id="loginTime" type="text" disabled placeholder="—" />
      </div>
      <div>
        <label>Time Since Login (minutes)</label>
        <input id="loginDeltaMin" type="text" disabled placeholder="—" />
      </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px;">
      <button id="getGPS">Get My Location</button>
      <button id="reload">Reload Dealer List</button>
      <button id="goCheckout" disabled>Go to Checkout</button>
    </div>

    <div style="margin-top:8px;">
      <span id="radiusInfo" class="badge"></span>
      <span id="accInfo" class="badge hidden"></span>
    </div>
  </div>

  <script>
    // ==== Utility functions ====
    function parseCSV(text) {
      const rows = []; let row = [], cell = '', inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];
        if (inQuotes) {
          if (c === '"' && n === '"') { cell += '"'; i++; }
          else if (c === '"') { inQuotes = false; }
          else { cell += c; }
        } else {
          if (c === '"') { inQuotes = true; }
          else if (c === ',') { row.push(cell); cell = ''; }
          else if (c === '\n') { row.push(cell); rows.push(row); row = []; cell = ''; }
          else if (c === '\r') { }
          else { cell += c; }
        }
      }
      if (cell.length || row.length) { row.push(cell); rows.push(row); }
      return rows;
    }
    const stripQuotesTrim = (s) => String(s ?? '').replace(/^"+|"+$/g, '').trim();
    const normalizeHeaders = (arr) => arr.map(h => stripQuotesTrim(h).toLowerCase());
    const uniqueSorted = (arr) => [...new Set(arr)].sort((a,b)=>a.localeCompare(b));
    function haversineMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ==== DOM refs ====
    const dealerInput = document.getElementById("dealerInput");
    const dealerSuggestions = document.getElementById("dealerSuggestions");
    const dealerCoords = document.getElementById("dealerCoords");
    const myCoords = document.getElementById("myCoords");
    const distanceEl = document.getElementById("distance");
    const statusEl = document.getElementById("status");
    const getGPSBtn = document.getElementById("getGPS");
    const reloadBtn = document.getElementById("reload");
    const goCheckoutBtn = document.getElementById("goCheckout");
    const radiusInfo = document.getElementById("radiusInfo");
    const accInfo = document.getElementById("accInfo");
    const loginTimeEl = document.getElementById("loginTime");
    const loginDeltaMinEl = document.getElementById("loginDeltaMin");

    const SHEET_URL_TIME = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQSE39NKkvwxpJz1O8QxCFuudjvn2CJY3nyYyq-4pdi5XNU3nhsHMaMVemNxFqazjcPYt51_EZ0g8r/pub?gid=1647008010&single=true&output=csv";

    let DEALERS = [];
    let SELECTED_DEALER = null;
    let MY_LOC = null;
    let SALES_NAME = "";

    const RADIUS_M = 100;
    radiusInfo.textContent = `Allowed radius: ${RADIUS_M} m`;

    // ==== Jam Login lookup ====
    async function lookupLoginTime() {
      if (!SHEET_URL_TIME || !SELECTED_DEALER || !SALES_NAME) return;
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const trigger = `${m}/${d}/${y}${SALES_NAME}${SELECTED_DEALER.name}`;
      loginTimeEl.value = "—";
      loginDeltaMinEl.value = "—";
      try {
        const res = await fetch(SHEET_URL_TIME, { cache: "no-store" });
        const text = await res.text();
        const rows = parseCSV(text);
        const header = normalizeHeaders(rows.shift());
        let triggerIdx = header.indexOf("trigger");
        if (triggerIdx < 0) triggerIdx = 9;
        let jamLoginIdx = header.indexOf("jam login");
        if (jamLoginIdx < 0) jamLoginIdx = 6;
        const row = rows.find(r => stripQuotesTrim(r[triggerIdx]) === trigger);
        if (!row) return;
        const jamRaw = stripQuotesTrim(row[jamLoginIdx] ?? "");
        let hh, mm;
        if (/^[0-2]?\d:[0-5]\d$/.test(jamRaw)) {
          [hh, mm] = jamRaw.split(":").map(n=>parseInt(n,10));
        } else {
          const num = Number(jamRaw);
          if (Number.isFinite(num) && num>=0 && num<1) {
            const totalMinutes = Math.round(num*24*60);
            hh = Math.floor(totalMinutes/60);
            mm = totalMinutes%60;
          }
        }
        if (hh!=null) {
          loginTimeEl.value = `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
          const loginDate = new Date(y, now.getMonth(), now.getDate(), hh, mm);
          let deltaMs = Date.now()-loginDate.getTime();
          if (deltaMs<0) deltaMs+=86400000;
          const deltaMin = Math.round(deltaMs/60000);
          loginDeltaMinEl.value = deltaMin;
        }
      } catch(e){console.error(e);}
    }

    // ==== Distance + Gate ====
    async function computeDistance() {
      if (!SELECTED_DEALER || !MY_LOC) { updateGate(); return; }
      const dist = Math.round(haversineMeters(MY_LOC.lat, MY_LOC.lng, SELECTED_DEALER.lat, SELECTED_DEALER.lng));
      distanceEl.value = dist;
      const within = dist<=RADIUS_M;
      statusEl.value = within?"WITHIN RADIUS":"OUT OF RADIUS";
      statusEl.className = within?"ok":"warn";
      const minSinceLogin = parseInt(loginDeltaMinEl.value,10);
      const validTime = Number.isFinite(minSinceLogin) && minSinceLogin>=15;
      goCheckoutBtn.disabled = !(within && validTime);
      radiusInfo.textContent = `Allowed radius: ${RADIUS_M} m (Time since login: ${validTime?"ok":"<15"})`;
    }

    function updateGate(){
      statusEl.value = "Select dealer & get GPS";
      goCheckoutBtn.disabled = true;
    }

    // ==== GPS ====
    getGPSBtn.addEventListener("click", ()=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        MY_LOC={lat:pos.coords.latitude,lng:pos.coords.longitude,acc:pos.coords.accuracy};
        myCoords.value=`${MY_LOC.lat.toFixed(6)}, ${MY_LOC.lng.toFixed(6)}`;
        accInfo.textContent=`Accuracy ±${Math.round(MY_LOC.acc)}m`;
        accInfo.classList.remove("hidden");
        lookupLoginTime().then(computeDistance);
      });
    });

  </script>
</body>
</html>
