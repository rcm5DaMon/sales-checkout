// ===== Jam Login lookup (pick the LATEST time on the sheet) =====
async function lookupLoginTime() {
  if (!SHEET_URL_TIME || !SELECTED_DEALER || !SALES_NAME) return;

  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  const trigger = `${m}/${d}/${y}${SALES_NAME}${SELECTED_DEALER.name}`;

  loginTimeEl.value = "—";
  loginDeltaMinEl.value = "—";

  try {
    const res = await fetch(SHEET_URL_TIME, { cache: "no-store" });
    if (!res.ok) throw new Error("Cannot fetch time CSV");
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) return;

    const header = normalizeHeaders(rows.shift());
    let triggerIdx  = header.indexOf("trigger");   if (triggerIdx  < 0) triggerIdx  = 9; // fallback
    let jamLoginIdx = header.indexOf("jam login"); if (jamLoginIdx < 0) jamLoginIdx = 6; // fallback

    // Collect all matching rows for today's trigger
    const matches = rows.filter(r => stripQuotesTrim(r[triggerIdx]) === trigger);
    if (!matches.length) return;

    // Helper: parse Jam Login into minutes since midnight (0..1439); return null if invalid
    const toMinutes = (raw) => {
      const s = stripQuotesTrim(raw ?? "");
      if (/^[0-2]?\d:[0-5]\d$/.test(s)) {
        const [H, M] = s.split(":").map(n => parseInt(n, 10));
        if (H >= 0 && H <= 23 && M >= 0 && M <= 59) return H * 60 + M;
        return null;
      }
      const num = Number(s); // Excel fraction of a day
      if (Number.isFinite(num) && num >= 0 && num < 1) {
        const total = Math.round(num * 24 * 60);
        return Math.max(0, Math.min(1439, total));
      }
      return null;
    };

    // Find the row with the LATEST Jam Login (max minutes)
    let best = null; // { minutes, hhmm: "HH:MM" }
    for (const r of matches) {
      const mins = toMinutes(r[jamLoginIdx]);
      if (mins == null) continue;
      if (!best || mins > best.minutes) {
        const hh = String(Math.floor(mins / 60)).padStart(2, "0");
        const mm = String(mins % 60).padStart(2, "0");
        best = { minutes: mins, hhmm: `${hh}:${mm}` };
      }
    }
    if (!best) return;

    // Show latest Jam Login
    loginTimeEl.value = best.hhmm;

    // Compute minutes since that latest login
    const loginDate = new Date(y, now.getMonth(), now.getDate(),
                               Math.floor(best.minutes / 60), best.minutes % 60, 0, 0);
    let deltaMs = Date.now() - loginDate.getTime();
    if (deltaMs < 0) deltaMs += 24 * 60 * 60 * 1000; // handle past-midnight case
    const deltaMin = Math.max(0, Math.round(deltaMs / 60000));
    loginDeltaMinEl.value = String(deltaMin);
  } catch (e) {
    console.error("Jam Login lookup error:", e);
  }
}
