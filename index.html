<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Location & Time Check</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .card { max-width: 760px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 12px; }
    h2 { margin-top: 0; }
    label { display:block; margin: 12px 0 6px; font-weight: 600; }
    input, select, button { padding: 10px; width: 100%; box-sizing: border-box; }
    input[disabled] { background: rgba(127,127,127,.08); }
    button { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .ok { color: #0a7b22; font-weight: 700; }
    .warn { color: #b45309; font-weight: 700; }
    .err { color: #b91c1c; font-weight: 700; }
    .muted { color: #666; font-size: 0.92rem; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; margin-left:8px; font-size: 0.85rem; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; margin:6px 6px 0 0; cursor:pointer; user-select:none; }
    .hidden { display:none; }
    .hint { font-size: .85rem; color: #555; margin-top: 4px; }
    .spinner { display:inline-block; width: 14px; height: 14px; border:2px solid #bbb; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: -2px; margin-right:6px;}
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="card">
    <h2>Sales Location & Time Check</h2>
    <p class="muted">Input your name and select dealer to check your location and time spent at the dealer.</p>

    <!-- Sales Name Input (native suggestions via datalist) -->
    <label for="salesNameInput">Sales Name</label>
    <input id="salesNameInput" type="text" placeholder="Type sales name..." list="salesNameList" autocomplete="off" />
    <datalist id="salesNameList"></datalist>
    <div id="salesNameSuggestions" class="hidden"></div>

    <!-- Dealer Name -->
    <label for="dealerInput">Search dealer by name</label>
    <input id="dealerInput" type="text" placeholder="Type dealer name…" autocomplete="off" />
    <div id="dealerSuggestions"></div>
    <div class="hint" id="dealerHint" aria-live="polite"></div>

    <!-- Coordinates -->
    <div class="row" style="margin-top:8px;">
      <div>
        <label>Dealer Coordinates</label>
        <input id="dealerCoords" type="text" disabled placeholder="—" />
      </div>
      <div>
        <label>Your Live GPS</label>
        <input id="myCoords" type="text" disabled placeholder="—" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Distance to Dealer (meters)</label>
        <input id="distance" type="text" disabled placeholder="—" />
      </div>
      <div>
        <label>Status</label>
        <input id="status" type="text" disabled placeholder="—" />
      </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px;">
      <button id="getGPS">Get My Location</button>
      <button id="reload">Reload Dealer List</button>
      <button id="goCheckout" disabled>Go to Checkout</button>
    </div>

    <div style="margin-top:8px;">
      <span id="radiusInfo" class="badge"></span>
      <span id="accInfo" class="badge hidden"></span>
    </div>

    <p class="muted" style="margin-top:12px;">
      Tip: Allow location permission and use a phone outdoors for better accuracy.
    </p>
  </div>

  <script>
    // ===================== Utilities =====================
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function parseCSV(text) {
      const rows = [];
      let row = [], cell = '', inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];
        if (inQuotes) {
          if (c === '"' && n === '"') { cell += '"'; i++; }
          else if (c === '"') { inQuotes = false; }
          else { cell += c; }
        } else {
          if (c === '"') { inQuotes = true; }
          else if (c === ',') { row.push(cell); cell = ''; }
          else if (c === '\n') { row.push(cell); rows.push(row); row = []; cell = ''; }
          else if (c === '\r') { }
          else { cell += c; }
        }
      }
      if (cell.length || row.length) { row.push(cell); rows.push(row); }
      return rows;
    }

    function stripQuotesTrim(s) {
      return String(s ?? '').replace(/^"+|"+$/g, '').trim();
    }

    function normalizeHeaders(arr) {
      return arr.map(h => stripQuotesTrim(h).toLowerCase());
    }

    function uniqueSorted(arr) {
      return [...new Set(arr)].sort((a,b)=>a.localeCompare(b));
    }

    function escJS(s) {
      return String(s).replace(/\\/g, "\\\\").replace(/'/g, "\\'");
    }

    function haversineMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function debounce(fn, delay = 200) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
    }

    // ===================== State & DOM =====================
    const salesNameInput = document.getElementById("salesNameInput");
    const salesNameList = document.getElementById("salesNameList");
    const salesNameSuggestions = document.getElementById("salesNameSuggestions");

    const dealerInput = document.getElementById("dealerInput");
    const dealerSuggestions = document.getElementById("dealerSuggestions");
    const dealerHint = document.getElementById("dealerHint");

    const dealerCoords = document.getElementById("dealerCoords");
    const myCoords = document.getElementById("myCoords");
    const distanceEl = document.getElementById("distance");
    const statusEl = document.getElementById("status");

    const getGPSBtn = document.getElementById("getGPS");
    const reloadBtn = document.getElementById("reload");
    const goCheckoutBtn = document.getElementById("goCheckout");
    const radiusInfo = document.getElementById("radiusInfo");
    const accInfo = document.getElementById("accInfo");

    // ----- CSV sources -----
    const CSV_URL_DEALERS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3Hpp6N8pjYkRMy-Pi58yCxZB5o-rCdQfnBv0Z_vHMq6Uii5uxG60BnpQVcsyDTg-X9-A-HPodXhpT/pub?output=csv";
    const CSV_URL_SALESMEN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTiHz0jejmmecSnTe5uK3Kwt_kx7HYcvMwRRQ_OeS1TA4evqMUwl8srVUe164DbJnxjYcuKuUsHQiFm/pub?gid=472318377&single=true&output=csv";

    // ✅ Your Time Sheet CSV (published link)
    const SHEET_URL_TIME = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQSE39NKkvwxpJz1O8QxCFuudjvn2CJY3nyYyq-4pdi5XNU3nhsHMaMVemNxFqazjcPYt51_EZ0g8r/pub?gid=1647008010&single=true&output=csv";

    let DEALERS = [];
    let SALESPEOPLE = [];
    let SELECTED_DEALER = null;
    let MY_LOC = null;
    let SALES_NAME = "";
    const RADIUS_M = 50000000000000000000000000000000000000000000000000000000000000000000; // adjust as needed

    radiusInfo.textContent = `Allowed radius: ${RADIUS_M} m`;

    // ===================== Load Dealers =====================
    async function loadDealers() {
      dealerSuggestions.innerHTML = `<span class="spinner"></span><span class="muted">Loading dealers…</span>`;
      dealerHint.textContent = "";
      try {
        const res = await fetch(CSV_URL_DEALERS, { cache: "no-store" });
        if (!res.ok) throw new Error("Cannot fetch dealer CSV");
        const text = await res.text();
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("Empty dealer CSV");

        const header = normalizeHeaders(rows.shift());
        const iName = header.findIndex(h => ["dealername","dealer name","name","dealer"].includes(h));
        const iLat  = header.findIndex(h => ["latitude","lat"].includes(h));
        const iLng  = header.findIndex(h => ["longitude","lng","lon","long"].includes(h));

        if (iName < 0 || iLat < 0 || iLng < 0) {
          throw new Error("CSV header must include DealerName, Latitude, Longitude");
        }

        DEALERS = rows.map(r => ({
          name: stripQuotesTrim(r[iName]),
          lat: parseFloat(stripQuotesTrim(r[iLat])),
          lng: parseFloat(stripQuotesTrim(r[iLng]))
        })).filter(d => d.name && Number.isFinite(d.lat) && Number.isFinite(d.lng));

        dealerSuggestions.innerHTML = `<span class="muted">${DEALERS.length} dealers loaded.</span>`;
        dealerHint.textContent = "Type to search and tap a suggestion pill to select.";
      } catch (e) {
        dealerSuggestions.innerHTML = `<span class="err">Error: ${e.message}</span>`;
      }
    }

    // ===================== Load Salespeople =====================
    async function loadSalespeople() {
      try {
        const res = await fetch(CSV_URL_SALESMEN, { cache: "no-store" });
        if (!res.ok) throw new Error("Cannot fetch salespeople CSV");
        const text = await res.text();
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("Empty salespeople CSV");

        const header = normalizeHeaders(rows.shift());
        const iName = header.findIndex(h => ["sales name","sales_name","salesname","name"].includes(h));
        if (iName < 0) throw new Error("CSV header must include 'Sales Name'");

        SALESPEOPLE = uniqueSorted(
          rows.map(r => stripQuotesTrim(r[iName])).filter(Boolean)
        );
        salesNameList.innerHTML = SALESPEOPLE.map(n => `<option value="${n}">`).join("");
      } catch (e) {
        console.error("Error loading salespeople:", e.message);
      }
    }

    loadDealers();
    loadSalespeople();
    reloadBtn.addEventListener("click", loadDealers);

    salesNameInput.addEventListener("change", () => {
      SALES_NAME = stripQuotesTrim(salesNameInput.value);
      salesNameSuggestions.innerHTML = "";
      computeDistance();
    });

    const updateDealerSuggestions = debounce(() => {
      const q = dealerInput.value.toLowerCase().trim();
      if (!q) { dealerSuggestions.innerHTML = ""; return; }
      const suggestions = DEALERS.filter(d => d.name.toLowerCase().includes(q)).slice(0, 50);
      dealerSuggestions.innerHTML = suggestions
        .map(d => `<div class="pill" onclick="selectDealer('${escJS(d.name)}')">${d.name}</div>`)
        .join("") || `<span class="muted">No matches.</span>`;
    }, 150);

    dealerInput.addEventListener("input", updateDealerSuggestions);

    window.selectDealer = function(dealerName) {
      const selected = DEALERS.find(d => d.name === dealerName);
      if (!selected) return;
      SELECTED_DEALER = selected;
      dealerInput.value = dealerName;
      dealerSuggestions.innerHTML = '';
      dealerCoords.value = `${selected.lat}, ${selected.lng}`;
      computeDistance();
    };

    getGPSBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        statusEl.value = "Geolocation not supported";
        statusEl.className = "err";
        return;
      }
      statusEl.value = "Requesting location…";
      statusEl.className = "";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          MY_LOC = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
          myCoords.value = `${MY_LOC.lat.toFixed(6)}, ${MY_LOC.lng.toFixed(6)} (±${Math.round(MY_LOC.acc)} m)`;
          accInfo.textContent = `Accuracy: ±${Math.round(MY_LOC.acc)} m`;
          accInfo.classList.remove("hidden");
          computeDistance();
        },
        (err) => {
          statusEl.value = `Location error: ${err.message}`;
          statusEl.className = "err";
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // ===================== Time Check =====================
    async function checkTimeSpent() {
      if (!SHEET_URL_TIME) return true;
      if (!SELECTED_DEALER || !SALES_NAME) return false;

      try {
        const dealer = SELECTED_DEALER.name;
        const date = new Date();
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const dateKey = `${y}-${m}-${d}`;
        const trigger = `${dateKey}${SALES_NAME}${dealer}`;

        const response = await fetch(SHEET_URL_TIME, { cache: "no-store" });
        if (!response.ok) throw new Error("Cannot fetch time CSV");
        const text = await response.text();
        const rows = parseCSV(text);

        // ⚠️ Adjust these indices if your sheet columns differ
        const TRIGGER_COL = 9; // 10th column
        const TIME_COL = 10;   // 11th column

        const match = rows.find(row => stripQuotesTrim(row[TRIGGER_COL]) === trigger);
        if (!match) return false;

        const timeSpent = parseInt(stripQuotesTrim(match[TIME_COL]), 10);
        return Number.isFinite(timeSpent) && timeSpent >= 2;
      } catch (e) {
        console.error("Time check error:", e);
        return false;
      }
    }

    // ===================== Distance + Gate =====================
    async function computeDistance() {
      if (!SELECTED_DEALER || !MY_LOC) { updateGate(); return; }
      const dist = Math.round(haversineMeters(MY_LOC.lat, MY_LOC.lng, SELECTED_DEALER.lat, SELECTED_DEALER.lng));
      distanceEl.value = dist;
      const isValidLocation = dist <= RADIUS_M;
      statusEl.value = isValidLocation ? "WITHIN RADIUS" : "OUT OF RADIUS";
      statusEl.className = isValidLocation ? "ok" : "warn";

      let isValidTime = true;
      if (isValidLocation) {
        isValidTime = await checkTimeSpent();
      }
      goCheckoutBtn.disabled = !(isValidLocation && isValidTime);
    }

    function updateGate() {
      const needDealer = !SELECTED_DEALER;
      const needGPS = !MY_LOC;
      if (needDealer && needGPS) { statusEl.value = "Select dealer & get GPS"; }
      else if (needDealer)       { statusEl.value = "Select dealer"; }
      else if (needGPS)          { statusEl.value = "Get GPS"; }
      statusEl.className = "";
      goCheckoutBtn.disabled = true;
      distanceEl.value = "";
    }

    goCheckoutBtn.addEventListener("click", () => {
      if (goCheckoutBtn.disabled) return;
      window.location.href = "https://your-checkout-page.com";
    });
  </script>
</body>
</html>
